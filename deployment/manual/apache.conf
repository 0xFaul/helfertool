<VirtualHost *:80>
    ServerName app.helfertool.org
    ServerAlias www.app.helfertool.org
    ServerAdmin admin@helfertool.org

    ServerSignature Off

    # SSL redirect
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^.*$ https://%{SERVER_NAME}%{REQUEST_URI} [L,NE,R=permanent]

    # logging
    CustomLog "${APACHE_LOG_DIR}/helfertool_access.log" combined
    ErrorLog "${APACHE_LOG_DIR}/helfertool_error.log"
</VirtualHost>

<VirtualHost *:443>
    ServerName app.helfertool.org
    ServerAlias www.app.helfertool.org
    ServerAdmin admin@helfertool.org

    ServerSignature Off

    # reverse proxy and static files
    ProxyPassMatch ^/static/ !
    ProxyPassMatch ^/media/ !
    # let's encrypt (you additionally need an alias for the well-known directory)
    ProxyPassMatch ^/.well-known/ !
    ProxyPass / uwsgi://127.0.0.1:3001/
    ProxyPassReverse / uwsgi://127.0.0.1:3001/

    <Directory />
        Require all denied
    </Directory>

    Alias /static/ /srv/helfertool/helfertool/static/
    Alias /media/ /srv/helfertool/helfertool/media/

    <Directory /srv/helfertool/helfertool/static/>
        Require all granted
    </Directory>

    <Directory /srv/helfertool/helfertool/media/>
        Require all granted
    </Directory>

    # error document in case uwsgi is stopped
    ErrorDocument 503 /static/helfertool/unavailable.html

    # ssl settings
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/ssl-cert-snakeoil.pem
    SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key

    Header set Strict-Transport-Security "max-age=15552000"

    # security options
    Header set X-Frame-Options DENY
    Header set X-Content-Type-Options nosniff
    Header set X-XSS-Protection "1; mode=block"
    Header set Content-Security-Policy "default-src 'none'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self'; form-action 'self'"

    # disable php
    <Files *>
        SetHandler default-handler
    </Files>

    # redirect to "app.helfertool.org" if necessary (without www)
    # enable if app should only be served under one domain, this is recommended
    #RewriteEngine On [NC]
    #RewriteCond %{HTTP_HOST} !(^app\.helfertool\.org)
    #RewriteCond %{REQUEST_URI} !^/.well-known(.*)
    #RewriteRule ^(.*)$ https://app.helfertool.org/$1 [R=301,NC,L]

    # logging
    CustomLog "${APACHE_LOG_DIR}/helfertool_access.log" combined
    ErrorLog "${APACHE_LOG_DIR}/helfertool_error.log"
</VirtualHost>
